!function(e){"use strict";function a(){return"ondrag"in document.createElement("a")}function n(e){"undefined"!=typeof e.dataTransfer&&"none"===e.dataTransfer.dropEffect&&("copy"===e.dataTransfer.effectAllowed||"move"===e.dataTransfer.effectAllowed?e.dataTransfer.dropEffect=e.dataTransfer.effectAllowed:("copyMove"===e.dataTransfer.effectAllowed||"copymove"===e.dataTransfer.effectAllowed)&&(e.dataTransfer.dropEffect=e.ctrlKey?"copy":"move"))}if(!a())return void e.module("ang-drag-drop",[]);window.jQuery&&-1===window.jQuery.event.props.indexOf("dataTransfer")&&window.jQuery.event.props.push("dataTransfer");var r=e.module("ang-drag-drop",[]);r.directive("uiDraggable",["$parse","$rootScope","$dragImage",function(a,r,t){return function(o,d,i){function f(e){setTimeout(function(){d.unbind("$destroy",f)},0);var t=i.dragChannel||"defaultchannel";if(r.$broadcast("ANGULAR_DRAG_END",e,t),n(e),e.dataTransfer&&"none"!==e.dataTransfer.dropEffect)if(i.onDropSuccess){var s=a(i.onDropSuccess);o.$evalAsync(function(){s(o,{$event:e})})}else if(i.onDropFailure){var l=a(i.onDropFailure);o.$evalAsync(function(){l(o,{$event:e})})}d.removeClass(v)}function s(n,r){var t;n&&n.dataTransfer&&n.dataTransfer.setDragImage&&(t=a(r),o.$apply(function(){var a,r=t(o,{$event:n});r&&e.isString(r)&&(a=document.getElementById(r),a&&n.dataTransfer.setDragImage(a,0,0))}))}function l(n){var l=!c||u.classList.contains(g);if(l){var p=i.dragChannel||"defaultchannel",$="";i.drag&&($=o.$eval(i.drag));var m=i.dragImage||null;d.addClass(v),d.bind("$destroy",f);var h=!(document.uniqueID||window.opera);if(m&&h){var D=a(i.dragImage);o.$apply(function(){var a=D(o,{$event:n});if(a&&(e.isString(a)&&(a=t.generate(a)),a.image)){var r=a.xOffset||0,d=a.yOffset||0;n.dataTransfer.setDragImage(a.image,r,d)}})}else i.dragImageElementId&&s(n,i.dragImageElementId);var b={data:$,channel:p},A=e.toJson(b);n.dataTransfer.setData("text",A),n.dataTransfer.effectAllowed="copyMove",r.$broadcast("ANGULAR_DRAG_START",n,p,b)}else n.preventDefault()}var g,u,c=!1,v=i.draggingClass||"on-dragging";d.attr("draggable",!1),o.$watch(i.uiDraggable,function(e){e?(d.attr("draggable",e),d.bind("dragend",f),d.bind("dragstart",l)):(d.removeAttr("draggable"),d.unbind("dragend",f),d.unbind("dragstart",l))}),e.isString(i.dragHandleClass)&&(c=!0,g=i.dragHandleClass.trim()||"drag-handle",d.bind("mousedown",function(e){u=e.target}))}}]),r.directive("uiOnDrop",["$parse","$rootScope",function(a,r){return function(t,o,d){function i(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation();var n=a(d.uiOnDragOver);return t.$evalAsync(function(){n(t,{$event:e,$channel:v})}),!1}function f(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),c--,0===c&&(t.$evalAsync(function(){D(t,{$event:e,$channel:v})}),o.addClass($),o.removeClass(m));var n=a(d.uiOnDragLeave);t.$evalAsync(function(){n(t,{$event:e,$channel:v})})}function s(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),0===c&&(t.$evalAsync(function(){h(t,{$event:e,$channel:v})}),o.removeClass($),o.addClass(m)),c++;var n=a(d.uiOnDragEnter);t.$evalAsync(function(){n(t,{$event:e,$channel:v})}),r.$broadcast("ANGULAR_HOVER",p)}function l(r){r.preventDefault&&r.preventDefault(),r.stopPropagation&&r.stopPropagation();var i=r.dataTransfer.getData("text");i=e.fromJson(i),n(r);var f=a(d.uiOnDrop);t.$evalAsync(function(){f(t,{$data:i.data,$event:r,$channel:i.channel})}),o.removeClass($),c=0}function g(e,a){if("*"===a)return!0;var n=new RegExp("(\\s|[,])+("+e+")(\\s|[,])+","i");return n.test(","+a+",")}function u(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.dataTransfer.dropEffect="none",!1}var c=0,v=d.dropChannel||"defaultchannel",p="",$=d.dragEnterClass||"on-drag-enter",m=d.dragHoverClass||"on-drag-hover",h=a(d.onDragEnter),D=a(d.onDragLeave),b=r.$on("ANGULAR_DRAG_START",function(e,n,r,c){p=r;var m=!0;if(g(r,v)||(m=!1),m&&d.dropValidate){var h=a(d.dropValidate);m=h(t,{$drop:{scope:t,element:o},$event:n,$data:c.data,$channel:c.channel})}m?(o.bind("dragover",i),o.bind("dragenter",s),o.bind("dragleave",f),o.bind("drop",l),o.addClass($)):(o.bind("dragover",u),o.bind("dragenter",u),o.bind("dragleave",u),o.bind("drop",u),o.removeClass($))}),A=r.$on("ANGULAR_DRAG_END",function(){o.unbind("dragover",i),o.unbind("dragenter",s),o.unbind("dragleave",f),o.unbind("drop",l),o.removeClass(m),o.removeClass($),o.unbind("dragover",u),o.unbind("dragenter",u),o.unbind("dragleave",u),o.unbind("drop",u)});t.$on("$destroy",function(){b(),A()}),d.$observe("dropChannel",function(e){e&&(v=e)})}}]),r.constant("$dragImageConfig",{height:20,width:200,padding:10,font:"bold 11px Arial",fontColor:"#eee8d5",backgroundColor:"#93a1a1",xOffset:0,yOffset:0}),r.service("$dragImage",["$dragImageConfig",function(a){function n(e,a,n){var t=e.measureText(a).width;if(t<n.width)return a;for(;t+n.padding>n.width;)a=a.substring(0,a.length-1),t=e.measureText(a+r).width;return a+r}var r="â€¦";this.generate=function(r,t){var o=e.extend({},a,t||{}),d=document.createElement("canvas");d.height=o.height,d.width=o.width;var i=d.getContext("2d");i.fillStyle=o.backgroundColor,i.fillRect(0,0,o.width,o.height),i.font=o.font,i.fillStyle=o.fontColor;var f=n(i,r,o);i.fillText(f,4,o.padding+4);var s=new Image;return s.src=d.toDataURL(),{image:s,xOffset:o.xOffset,yOffset:o.yOffset}}}])}(angular);